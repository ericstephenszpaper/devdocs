<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_312) on Mon Jun 13 14:17:42 EDT 2022 -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Overview (zPaper Gateway WebApp 4.0 API)</title>
<meta name="date" content="2022-06-13">
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script type="text/javascript" src="script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="Overview (zPaper Gateway WebApp 4.0 API)";
        }
    }
    catch(err) {
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li class="navBarCell1Rev">Overview</li>
<li><a href="com/zpaper/gateway/package-summary.html">Package</a></li>
<li>Class</li>
<li>Use</li>
<li><a href="overview-tree.html">Tree</a></li>
<li><a href="deprecated-list.html">Deprecated</a></li>
<li><a href="index-all.html">Index</a></li>
<li><a href="help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li>Prev</li>
<li>Next</li>
</ul>
<ul class="navList">
<li><a href="index.html?overview-summary.html" target="_top">Frames</a></li>
<li><a href="overview-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<div class="header">
<h1 class="title">zPaper Gateway WebApp 4.0 API</h1>
</div>
<div class="header">
<div class="subTitle">
<div class="block">
    The zPaper Gateway is a Breakfast Club project that came from the February 2018
    <a href="https://docs.google.com/document/d/14YSMiA88aYNqJ9Q4mZOkof6EAOuBbKNEz1qxlRtSRVQ">Blue Sky Day</a>
    session orchestrated by Mary Fajimi and designed and implemented by the zPaper development team.</div>
</div>
<p>See: <a href="#overview.description">Description</a></p>
</div>
<div class="contentContainer">
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Packages table, listing packages, and an explanation">
<caption><span>Packages</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Package</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="com/zpaper/gateway/package-summary.html">com.zpaper.gateway</a></td>
<td class="colLast">
<div class="block">This is the core package of the zPaper Gateway project.</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="contentContainer"><a name="overview.description">
<!--   -->
</a>
<div class="block"><p>
    The zPaper Gateway is a Breakfast Club project that came from the February 2018
    <a href="https://docs.google.com/document/d/14YSMiA88aYNqJ9Q4mZOkof6EAOuBbKNEz1qxlRtSRVQ">Blue Sky Day</a>
    session orchestrated by Mary Fajimi and designed and implemented by the zPaper development team.
</p>
<p>
    The initial justification for this project was to ease the pain related to sandbox refreshes related to the
    OutboundMessage endpoint. Previously, when a sandbox was refreshed, the OutboundMessage endpoint had to be corrected
    by hand or the Salesforce Outbound Messages intended for sandboxes end up in production servers where they
    end up in errors and cause alarms.
</p>
<p>
    The zPaper Gateway allows all outbound messages to be routed to
    <code>https://gw.zpaper.com/services/OutboundMessageService</code>
    which will then proxy to the proper zPaper server.
</p>
<p>
    The zPaper Gateway has been extended since its inception and now consists of two proxy endpoints and one redirect endpoint:
</p>
    <dl>
    <dt><span style="font-weight: bold"><a href="com/zpaper/gateway/OutboundMessageProxyServlet.html" title="class in com.zpaper.gateway"><code>OutboundMessageProxyServlet</code></a></span></dt>
    <dd style="margin-bottom: 1em;">
        <ol>
            <li>Extracts the Deployment index value from the outbound message.</li>
            <li>Finds the Deployment record by the index.</li>
            <li>Proxies the entire message to the server referenced by the Deployment__c.Server__c field.</li>
        </ol>
        <span style="font-weight: bold">Example:</span><br>
        <code>&lt;url-pattern&gt;/services/OutboundMessageService&lt;/url-pattern&gt;</code><br>
        Incoming: <code>https://gw.zpaper.com/services/OutboundMessageService</code><br>
        Proxies to: <code>https://zp14.zpaper.com/kb/services/OutboundMessageService</code><br>
    </dd>
    <dt><span style="font-weight: bold"><a href="com/zpaper/gateway/ZippiProxyServlet.html" title="class in com.zpaper.gateway"><code>ZippiProxyServlet</code></a></span></dt>
    <dd style="margin-bottom: 1em;">
        <ol>
            <li>Retrieves the Deployment index value from the request headers.</li>
            <li>Finds the Deployment record by the index.</li>
            <li>Proxies the entire message to the server referenced by the Deployment__c.Server__c field.</li>
        </ol>
        <span style="font-weight: bold">Example:</span><br>
        <code>&lt;url-pattern&gt;/zippi/*&lt;/url-pattern&gt;</code><br>
        Incoming: <code>https://gw.zpaper.com/zippi/action</code><br>
        Proxies to: <code>https://zp14.zpaper.com/zippi/action</code><br>
    </dd>
    <dt><span style="font-weight: bold"><a href="com/zpaper/gateway/KBRedirectorServlet.html" title="class in com.zpaper.gateway"><code>KBRedirectorServlet</code></a></span></dt>
    <dd style="margin-bottom: 1em;">
        <ol>
            <li>Retrieves the Deployment index value from the request parameters.</li>
            <li>Finds the Deployment record by the index.</li>
            <li>Redirects the request to the server referenced by the Deployment__c.Server__c field.</li>
        </ol>
        <span style="font-weight: bold">Example:</span><br>
        <code>&lt;url-pattern&gt;/kb/*&lt;/url-pattern&gt;</code><br>
        Incoming: <code>https://gw.zpaper.com/kb/jsp/SF_find.jsp?with=SF_files.jsp&go=SF_faxFrames.jsp&SFtype=All&SFserver=https%3A%2F%2Fzpaper-qa03rube-dev-ed.my.salesforce.com%2Fservices%2FSoap%2Fu%2F31.0%2F00D36000000KkTj&SFsession=00D36000000KkTj%21ARMAQGjLDS9h.WXMyaGsSQNt8u1TCHIB.YwWea1rAuPIMM9.nlVJtYus0Qjcpwp._pdnyk_cup_7kPhFI64oW0qAtYHfzClc</code><br>
        Redirected to:<code>https://zp14.zpaper.com/kb/jsp/SF_find.jsp?with=SF_files.jsp&go=SF_faxFrames.jsp&SFtype=All&SFserver=https%3A%2F%2Fzpaper-qa03rube-dev-ed.my.salesforce.com%2Fservices%2FSoap%2Fu%2F31.0%2F00D36000000KkTj&SFsession=00D36000000KkTj%21ARMAQGjLDS9h.WXMyaGsSQNt8u1TCHIB.YwWea1rAuPIMM9.nlVJtYus0Qjcpwp._pdnyk_cup_7kPhFI64oW0qAtYHfzClc</code>
    </dd>
    </dl>
    <h3>Configuration</h3>
    <div style="margin-left: 4em">
        Configuration for the gateway is provided by parameters in the context.xml:<br>
<pre>
    &lt;parameter name="redisHost" value="dev-redis.XXXXXXXXXXXXXXXX.cache.amazonaws.com" /&gt;
    &lt;parameter name="redisPort" value="6379" /&gt;
</pre>
    </div>
    <h3>Build</h3>
<div style="margin-left: 4em">
The steps to build the gateway server:
<pre>
<code>
# On AWS console in accountId: 240202421648 N. Virginia us-east-1
ami-0c6b1d09930fac512
m5a.large
dev-vpc
us-east-1b
disable
dev-zpserver-role

secgrp-dev-zpserver
zpaper-us-east-1-dev
Name: dev-gwc.zpaper.com

######
# ssh through dev-bastion to IP in new instance
sudo su
ts=`date +%Y%m%d%H%M%S`
yum -y update
amazon-linux-extras enable tomcat8.5
yum clean metadata
yum -y install java-1.8.0-openjdk-devel.x86_64 apr tomcat awslogs
sed -i.${ts} -e '$a\
[/var/log/tomcat/gateway-all]\
datetime_format = %b %d %H:%M:%S\
file = /var/log/tomcat/gateway-all.log\
buffer_duration = 5000\
log_stream_name = {instance_id}\
initial_position = start_of_file\
log_group_name = /var/log/tomcat/gateway-all\
\
[/var/log/tomcat/gateway-error]\
datetime_format = %b %d %H:%M:%S\
file = /var/log/tomcat/gateway-error.log\
buffer_duration = 5000\
log_stream_name = {instance_id}\
initial_position = start_of_file\
log_group_name = /var/log/tomcat/gateway-error\
' /etc/awslogs/awslogs.conf

#CMA190610 maybe later: sed -i.${ts} -e '$aexport LD_LIBRARY_PATH="/usr/lib64"' /etc/tomcat/tomcat.conf
aws s3 cp s3://release.zpaper.com/gateway-1.4.0-SNAPSHOT.war /tmp/ROOT.war
[ -e /usr/share/tomcat/webapps/ROOT ] && rm -rf /usr/share/tomcat/webapps/ROOT
unzip -qd /usr/share/tomcat/webapps/ROOT /tmp/ROOT.war
rm -rf /tmp/ROOT.war
chown -R tomcat:tomcat /usr/share/tomcat/webapps/ROOT

systemctl enable awslogsd
systemctl start awslogsd
systemctl enable tomcat
systemctl start tomcat
</code>
</pre>
</div>
    <h3>Logs</h3>
<div style="margin-left: 4em">
    Logs are visible via the AWS Cloudwatch Logs console (e.g. https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logStream:group=/var/log/tomcat/gateway-all)
</div><p>
<h3>Notes</h3>
<div style="margin-left: 4em">
    This project is designed to be load balanced behind an AWS ALB.
    The structure of the code lends itself to be considered for use in an AWS Lambda server behind the AWS API Gateway service.
</div>
<p>
        1.2 This has been extended to support Zippi proxy.
    <br>1.3 This has been extended to support kb/jsp/SF_find.jsp proxy
    <br>1.4 This has been enhanced to rely on the AWS Elasticache Redis services.
    <br>2.2 This has been enhanced to rely solely on the AWS Elasticache Redis services. Also modified to use X-API-Key as purely opaque index.
    <br>2.3 This has been enhanced to use the channel parameter as an index.  In the ZippiProxyServlet, the X-API-Key is added to the proxied request header if necessary.
</p></div>
</div>
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li class="navBarCell1Rev">Overview</li>
<li><a href="com/zpaper/gateway/package-summary.html">Package</a></li>
<li>Class</li>
<li>Use</li>
<li><a href="overview-tree.html">Tree</a></li>
<li><a href="deprecated-list.html">Deprecated</a></li>
<li><a href="index-all.html">Index</a></li>
<li><a href="help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li>Prev</li>
<li>Next</li>
</ul>
<ul class="navList">
<li><a href="index.html?overview-summary.html" target="_top">Frames</a></li>
<li><a href="overview-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
<p class="legalCopy"><small>Copyright &#169; 2022 zPaper. All rights reserved.</small></p>
</body>
</html>
